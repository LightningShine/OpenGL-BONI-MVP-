# ?????? ????????????? ? ???????? ???????????

## 1. ? ???????? ????? ???????

### GetVehiclePreviousLapTime()
```cpp
float RaceManager::GetVehiclePreviousLapTime(int32_t vehicleID) const
{
    auto it = m_vehicleTimings.find(vehicleID);
    if (it != m_vehicleTimings.end())
    {
        const auto& timing = it->second;
        int previousLapNumber = timing.currentLapNumber - 1;
        
        auto lapIt = timing.laps.find(previousLapNumber);
        if (lapIt != timing.laps.end())
            return lapIt->second.lapTime;
    }
    return -1.0f;
}
```

**???????? ? ???????? ???????????:** ? ??
- ?? ??????? ?? ????????? ?????? (?????????/???????? ??????)
- ?????????? ?????? vehicleID ?? ??????
- ???????? ? ????? ??????????? ??????

---

### GetVehicleDeltaTime()
```cpp
float RaceManager::GetVehicleDeltaTime(int32_t vehicleID) const
{
    // ???????? timing.currentLapTimer ? ?????????? ? ????????? ??????
    // ?????????? Config::LAP_DELTA_COMPARE_MODE
}
```

**???????? ? ???????? ???????????:** ? ??
- ?? ??????? ?? ????????? ?????????
- ?????????? ???????? ?????? ?? ??????? ??????
- ????????: ??????? ?????????? ?????????? ?????? ?????? ?????

**?? ???????????:**
?????? delta ???????????? ?????? ????? ?????????? ?????.
? ????????? ?????? delta ??????????? ? ???????? ??????? ?? ?????? ???????.

---

### GetVehicleCurrentLapNumber()
```cpp
int RaceManager::GetVehicleCurrentLapNumber(int32_t vehicleID) const
{
    auto it = m_vehicleTimings.find(vehicleID);
    if (it != m_vehicleTimings.end())
        return it->second.currentLapNumber;
    return 0;
}
```

**???????? ? ???????? ???????????:** ? ??
- ??????? getter ?? timing data
- ?? ??????? ?? ????????? ??????

---

## 2. ?? ????????? ??? ???????? ??????????

### ??????? flow (?????????):
```
ESP32_Code.cpp simulationThreadWorker()
    ??> ????????? vehicle.m_track_progress
    ??> ????????? vehicle.m_normalized_x/y
    ??> ????????? vehicle.m_prev_x/y
            ?
RaceManager::Update()
    ??> ????????? ??????????? ?????/??????
    ??> ????????? timing.currentLapTimer
    ??> ?????????? lap times
```

### ??????????? flow (???????? ??????????):
```
Client.cpp ???????? TelemetryPacket
    ?
? ??????: ?????? ???????? ??????
? ?????: ?????????/????????? ?????? ? g_vehicles

???????? ? Client.cpp:
{
    std::lock_guard<std::mutex> lock(g_vehicles_mutex);
    
    // ????????? ?????????? ?? ??????
    auto it = g_vehicles.find(pData->ID);
    
    if (it == g_vehicles.end()) {
        // ??????? ????? ??????
        g_vehicles[pData->ID] = Vehicle(*pData);
    } else {
        // ????????? ????????????
        Vehicle& vehicle = it->second;
        vehicle.m_prev_x = vehicle.m_normalized_x;
        vehicle.m_prev_y = vehicle.m_normalized_y;
        
        vehicle.m_lat_dd = pData->lat / 1e7;
        vehicle.m_lon_dd = pData->lon / 1e7;
        vehicle.m_speed_kph = pData->speed / 100.0;
        // ... ? ?.?.
        
        coordinatesToMeters(vehicle.m_lat_dd, vehicle.m_lon_dd, 
                           vehicle.m_meters_easting, vehicle.m_meters_northing);
        getCoordinateDifferenceFromOrigin(vehicle.m_meters_easting, 
                                         vehicle.m_meters_northing,
                                         vehicle.m_normalized_x, 
                                         vehicle.m_normalized_y);
        
        vehicle.m_last_update_time = std::chrono::steady_clock::now();
    }
}
```

### ?? ?????: m_track_progress
? ????????? `m_track_progress` ??????????? ?????????????:
```cpp
// ESP32_Code.cpp
vehicle.m_track_progress = currentDistance / total_track_length;
```

??? ???????? ?????????? ????? ?????????:
```cpp
// ????? ????????? ??????
vehicle.m_track_progress = CalculateProgressAlongTrack(
    vehicle.m_normalized_x, 
    vehicle.m_normalized_y, 
    g_smooth_track_points
);
```

??? `CalculateProgressAlongTrack()` - ??? ??????? ??????? ??????? ????????? ????? ?? ?????
? ????????? ???????? (0.0-1.0) ????? ??????.

---

## 3. ?? ??? ????????? TIME DIFF ? ????????? ??????

### ???? Delta ? ???????????????? ??????????? (F1, iRacing, ACC):

#### A. **Personal Best Delta** (??????? ??????????)
```
Delta = Current Lap Time - Personal Best Lap Time
```
**??????:**
- Best lap: 1:23.456
- Current: 1:25.123
- Delta: +1.667 (????????? ?? 1.6 ???)

**????????:** ?????????? ??????? ?????? ????? ?????????? ?????.

---

#### B. **Live Sector Delta** ? (???????????? ? F1)
?????? ??????? ?? **???????** (?????? 3):

```
Track:
?? Sector 1 (0.00 - 0.33)
?? Sector 2 (0.33 - 0.66)
?? Sector 3 (0.66 - 1.00)
```

**??? ????????:**
1. ???????????? ????? ??????????? ??????? ??????? ? ????????? ?????
2. ? ??????? ????? ??? ??????????? ??????? ???????:
   ```
   Delta_S1 = Current_S1_Time - Best_S1_Time
   Delta_S2 = Current_S2_Time - Best_S2_Time
   Delta_S3 = Current_S3_Time - Best_S3_Time
   ```

**??????:**
```
Best Lap: 1:23.456
  Sector 1: 27.123s
  Sector 2: 28.456s
  Sector 3: 27.877s

Current Lap (? ????????):
  Sector 1: 26.890s ? Delta: -0.233 (???????, ???????!)
  Sector 2: 29.120s ? Delta: +0.664 (???????, ?????????)
  Sector 3: ??? (??? ?? ??????)
  
????? Delta ????? S2: -0.233 + 0.664 = +0.431 (??????? ?? 0.4 ???)
```

---

#### C. **Real-Time Point-by-Point Delta** ?? (iRacing, ACC)
????? ?????? ??????? - ?????????? ?? ?????? ????? ??????:

```
1. ?????????? ????????? ????:
   track_progress ? time_at_progress
   
   0.000 ? 0.000s
   0.001 ? 0.084s
   0.002 ? 0.168s
   ...
   0.500 ? 41.728s (???????? ?????)
   ...
   1.000 ? 83.456s (?????)

2. ? ??????? ????? ?? ?????? ?????:
   current_progress = 0.345
   current_time = 29.450s
   
   reference_time = LookupTime(0.345) // 28.890s ?? ?????????? ?????
   
   Delta = current_time - reference_time
        = 29.450 - 28.890
        = +0.560s (??????? ?? 0.56 ???)
```

**?????????:**
```
?? ?????? ????????? ???????????:
???????????????????
? Delta: +0.560   ? ? ??????? (?????????)
? ?????????????   ? ? ????????-??? ?????
???????????????????
```

---

## 4. ?? ?????????? LIVE DELTA

### ??????? A: Sector-Based Delta (?????)

**1. ???????? ? Config.h:**
```cpp
namespace RaceConstants {
    static constexpr int SECTOR_COUNT = 3;
    static constexpr float SECTOR_1_END = 0.33f;
    static constexpr float SECTOR_2_END = 0.66f;
}
```

**2. ???????? ? VehicleTimingData:**
```cpp
struct VehicleTimingData {
    // ???????????? ????...
    
    // ????? ??? sector delta:
    std::array<float, 3> currentSectorTimes;   // ??????? ??????? ????????
    std::array<float, 3> referenceSectorTimes; // ????????? ??????? ????????
    int currentSector;                         // 0, 1, 2
    float sectorStartTime;                     // ????? ?????? ???????? ???????
};
```

**3. ???????? RaceManager::Update():**
```cpp
// ????????? ??????????? ?????? ????????
float progress = vehicle.m_track_progress;

if (progress >= 0.33f && timing.currentSector == 0) {
    // ????????? Sector 1
    timing.currentSectorTimes[0] = timing.currentLapTimer - timing.sectorStartTime;
    timing.currentSector = 1;
    timing.sectorStartTime = timing.currentLapTimer;
}
else if (progress >= 0.66f && timing.currentSector == 1) {
    // ????????? Sector 2
    timing.currentSectorTimes[1] = timing.currentLapTimer - timing.sectorStartTime;
    timing.currentSector = 2;
    timing.sectorStartTime = timing.currentLapTimer;
}
```

**4. ????? ????? GetLiveSectorDelta():**
```cpp
float RaceManager::GetLiveSectorDelta(int32_t vehicleID) const
{
    auto it = m_vehicleTimings.find(vehicleID);
    if (it == m_vehicleTimings.end())
        return 0.0f;
    
    const auto& timing = it->second;
    float totalDelta = 0.0f;
    
    // ????????? ?????? ??????????? ????????
    for (int s = 0; s < timing.currentSector; s++) {
        totalDelta += (timing.currentSectorTimes[s] - timing.referenceSectorTimes[s]);
    }
    
    return totalDelta;
}
```

---

### ??????? B: Point-by-Point Delta (??????, ???????)

**1. ???????? ? VehicleTimingData:**
```cpp
struct VehicleTimingData {
    // ???????????? ????...
    
    // ????? ??? point-by-point delta:
    std::map<float, float> referenceLapData; // progress ? time
    int referenceLapNumber;                  // ????? ???? ?????????? ??? ??????
};
```

**2. ?????????? ????????? ????:**
```cpp
void RaceManager::Update(float deltaTime)
{
    // ... ???????????? ??? ...
    
    // ???? ??? ?????? ????, ?????????? ???
    if (timing.laps[lapNumber].lapTime < timing.bestLapTime) {
        // ????????? ??? ?????????
        timing.referenceLapNumber = lapNumber;
        // referenceLapData ??? ??????? ?? ????? ?????
    }
}
```

**3. ?????????? ?????? ? ???????? ???????:**
```cpp
// ? Update() ?? ?????? ?????:
if (timing.hasStartedFirstLap) {
    float progress = vehicle.m_track_progress;
    float currentTime = timing.currentLapTimer;
    
    // ?????????? ??????? ????? (??? ???????? ???????)
    timing.currentLapData[progress] = currentTime;
}
```

**4. ????????? live delta:**
```cpp
float RaceManager::GetLivePointDelta(int32_t vehicleID) const
{
    auto it = m_vehicleTimings.find(vehicleID);
    if (it == m_vehicleTimings.end())
        return 0.0f;
    
    const auto& timing = it->second;
    
    // ??? ?????????? ?????
    if (timing.referenceLapData.empty())
        return 0.0f;
    
    float currentProgress = /* ???????? ?? vehicle */;
    float currentTime = timing.currentLapTimer;
    
    // ??????? ????????? ????? ? ????????? ?????
    auto it_ref = timing.referenceLapData.lower_bound(currentProgress);
    if (it_ref == timing.referenceLapData.end())
        return 0.0f;
    
    float referenceTime = it_ref->second;
    
    return currentTime - referenceTime;
}
```

---

## 5. ?? ????????????

### ??? ??????? ??????? (???????):
? **???????? ??????:**
- ?????????? delta ????? ?????????? ?????
- ?????????? ? best/previous/specific lap
- ?????????? ??? ??????? ??????????

? **???????????:**
- ?? ?????????? live delta ?? ????? ?????
- ?????????? ?????? ??? ??????? ?????

### ??? ?????????? (sector-based):
? **????????????? ???????????:**
1. Sector-based delta (3 ???????)
2. ?????????? ????? ???????? (???????/??????????/???????)
3. ????????? ?????? ?????? ? ???????? ???????

**????????????:**
- ???????? ????? ??? ?????? ?????
- ?? ??????????? ??????? (?????? 3 ???????? ?? ????)
- ???????????? ? ???????? ??????

### ??? pro-?????? (point-by-point):
? **????? ??????:**
- Delta ??????????? ?????? ????
- ????? ??????? ??????? ?? ???? ??????
- ??? ? iRacing/ACC

? **?????????:**
- ????? ??????? ~1000 ????? ?? ????
- ???????????? ????? ???????
- ?????? ???????? ?? ??????

---

## 6. ? ???????? ?????????????

| ??????? | ????????? | ???????? ?????????? | ????????? ????????? |
|---------|-----------|---------------------|---------------------|
| GetVehiclePreviousLapTime() | ? | ? | ? ??? |
| GetVehicleDeltaTime() | ? | ? | ? ??? |
| GetVehicleCurrentLapNumber() | ? | ? | ? ??? |
| g_focused_vehicle_id ??????? | ? | ? | ? ??? |
| RaceManager::Update() | ? | ? | ?? ????? m_track_progress |
| Lap crossing detection | ? | ? | ? ??? |
| Live delta | ? | ? | ?? ????? ??????????? |

**??? ????? ???????? ??? ???????? ??????????:**
1. ? ? Client.cpp: ????????/?????????? g_vehicles ?? ???????
2. ? ?????????? m_track_progress ?? ????????? GPS
3. ?? (???????????) Sector-based ??? point-by-point delta

---

## 7. ?? ??? ??? ????????? CLIENT.CPP

```cpp
// ? Client.cpp, ??????? ??? ?????????????? ??????

#include "../vehicle/Vehicle.h"
#include "../racing/RaceManager.h"

// ????? ????????? TelemetryPacket:
if (msg_type == PacketType::TELEMETRY)
{
    TelemetryPacket* pData = (TelemetryPacket*)pIncomingMsg[i]->m_pData;
    
    // ? ???????/????????? ?????? ? g_vehicles
    {
        std::lock_guard<std::mutex> lock(g_vehicles_mutex);
        
        auto it = g_vehicles.find(pData->ID);
        
        if (it == g_vehicles.end()) {
            // ??????? ????? ?????? ?? ??????
            g_vehicles[pData->ID] = Vehicle(*pData);
            std::cout << "[CLIENT] Created vehicle #" << pData->ID << std::endl;
        } else {
            // ????????? ???????????? ??????
            Vehicle& vehicle = it->second;
            
            // ????????? ?????????? ??????? (??? RaceManager)
            vehicle.m_prev_x = vehicle.m_normalized_x;
            vehicle.m_prev_y = vehicle.m_normalized_y;
            
            // ????????? ??????
            vehicle.m_lat_dd = pData->lat / 1e7;
            vehicle.m_lon_dd = pData->lon / 1e7;
            vehicle.m_speed_kph = pData->speed / 100.0;
            vehicle.m_acceleration = pData->acceleration / 100.0;
            vehicle.m_g_force_x = pData->gForceX / 100.0;
            vehicle.m_g_force_y = pData->gForceY / 100.0;
            vehicle.m_fix_type = pData->fixtype;
            
            // ???????????? GPS ? ????? ? normalized
            coordinatesToMeters(vehicle.m_lat_dd, vehicle.m_lon_dd, 
                               vehicle.m_meters_easting, vehicle.m_meters_northing);
            getCoordinateDifferenceFromOrigin(vehicle.m_meters_easting, 
                                             vehicle.m_meters_northing,
                                             vehicle.m_normalized_x, 
                                             vehicle.m_normalized_y);
            
            // ?? ?????: ????????? track_progress
            vehicle.m_track_progress = CalculateProgressAlongTrack(
                vehicle.m_normalized_x, 
                vehicle.m_normalized_y,
                g_smooth_track_points
            );
            
            vehicle.m_last_update_time = std::chrono::steady_clock::now();
        }
    }
    
    pIncomingMsg[i]->Release();
}
```

**??? ????? CalculateProgressAlongTrack():**
??? ??????? CalculateDistanceFromStart() ?? RaceManager, ?? ?????????? ? ????????? ???????.

---

## ?????

? **??? ????? ??????? ?????? ? ???????? ??????????**
?? **????? ????????:** ????????? ??????? ? Client.cpp
?? **?????????????:** Sector-based live delta ??? ????????????????? ??????
