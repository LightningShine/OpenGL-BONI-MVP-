# ?? ????????? ??????????? - ??????? ??????????

## ? ??????? ????????

### 1. ???? 8080 ?????
**???????:** ???????? ? `main.cpp` ?? ???? **8081** (??? ????? ?????????)

###  2. `TelemetryServer.h` ?? ??????????
**???????:** ??????? ??? ?????????? ?? `main.cpp`

### 3. ?????? ?? ?????????????? ??? ?????
**???????:** ? `main.cpp` ???????? ?? `RenderVenchiles(true)`

### 4. Origin ?? ???????????????
**???????:** ???????? ????????????? ? ?????? `main()`

---

## ? ??? ????? ???????? ? ????

### ????: `OpenGL\OpenGL main.cpp`

#### ????????? 1: ????????? (?????? ~10)
```cpp
// ? ???????:
#include "TelemetryServer.h"

// ? ?????? ???? ??????:
#include "Server.h"
```

#### ????????? 2: ?????????? ?????????? (?????? ~13)
```cpp
// ? ???????:
TelemetryServer telemetryServer;

// ? ?????? ???????? ??????:
VenchileManager venchileManager;
```

#### ????????? 3: ???????? extern (????? ?????????? ??????????)
```cpp
// ? ????????:
extern JsonInput jsonClass;
```

#### ????????? 4: ?????? main() (?????? ~100)
```cpp
int main()
{
    cout << "========================================\n";
    cout << "   RaceMap - Starting Application\n";
    cout << "========================================\n\n";

    // ? ????????: ????????????? origin
    cout << "[Init] Checking origin coordinates...\n";
    
    if (jsonClass.input_latitude == 0.0 && jsonClass.input_longitude == 0.0)
    {
        cout << "[WARNING] Origin not set! Using default (Riga, Latvia)\n";
        jsonClass.input_latitude = 56.9496;
        jsonClass.input_longitude = 24.1052;
        CordinateToMetersUTM(jsonClass.input_latitude, jsonClass.input_longitude, 
                             jsonClass.easting, jsonClass.northing);
    }
    
    cout << "[Init] Origin: (" << jsonClass.input_latitude << ", " 
         << jsonClass.input_longitude << ")\n\n";

    // ? ??????? ???? ???? ? telemetryServer:
    // telemetryServer.SetCallback(OnTelemetryReceived);
    // if (telemetryServer.Start(TELEMETRY_DEFAULT_PORT)) { ... }

    // ? ???????? ??:
    const uint16_t SERVER_PORT = 8081;  // ??????? ? 8080!
    
    cout << "[Server] Starting Global HTTP Server on port " << SERVER_PORT << "...\n";
    
    if (StartGlobalHttpServer(&venchileManager, SERVER_PORT))
    {
        cout << "[Main] ? Server started on port " << SERVER_PORT << "!\n";
        cout << "[Main] Configure OwnTracker: http://YOUR_PUBLIC_IP:" << SERVER_PORT << "/telemetry\n\n";
    }
    else
    {
        cerr << "[Main] ?? Failed to start server! Check port availability.\n\n";
    }

    // ????????? ??? GLFW ??? ?????????...
}
```

#### ????????? 5: Render loop (?????? ~290)
```cpp
// ? ????:
venchileManager.RenderVenchiles(g_trackLoaded);

// ? ???????? ??:
venchileManager.RenderVenchiles(true);  // ?????? ????????????

// ? ???????? debug ?????:
static int frameCount = 0;
if (++frameCount % 60 == 0)  // ??? ? ???????
{
    size_t vehicleCount = venchileManager.GetVenchileCount();
    if (vehicleCount > 0)
    {
        cout << "[Render] Vehicles: " << vehicleCount 
             << " | Track: " << (g_trackLoaded ? "YES" : "NO") << "\n";
    }
}
```

#### ????????? 6: Cleanup (????? main())
```cpp
// ? ???????:
telemetryServer.Stop();

// ? ?????? ???? ??????:
StopGlobalHttpServer();
```

---

### ????: `OpenGL\Venchile.cpp`

#### ????????? 1: ????????? (?????? ~3)
```cpp
// ? ???????:
#include "TelemetryServer.h"

// ? ?????? ???????? ??????:
#include "VENCHILEH.h"
#include "Input.h"
#include <cmath>
#include <UTMUPS.hpp>
```

#### ????????? 2: RenderVenchiles (?????? ~120)
```cpp
void VenchileManager::RenderVenchiles(bool trackLoaded)
{
    // ? ???????:
    // if (!trackLoaded) { return; }
    
    // ? ???????? ??:
    std::lock_guard<std::mutex> lock(VenchileMutex);
    
    if (venchiles.empty())
    {
        return;  // ??? ?????
    }
    
    // Debug info (?????? ??? ????????? ??????????)
    static size_t lastCount = 0;
    if (venchiles.size() != lastCount)
    {
        std::cout << "[Render] Drawing " << venchiles.size() << " vehicle(s)\n";
        lastCount = venchiles.size();
    }
    
    for (const auto& vehicle : venchiles)
    {
        if (HasValidFix(vehicle))
        {
            DrawVenchileShape(vehicle);
        }
    }
}
```

---

## ?? ??????? ????????

### 1. ??????? ????????? ? ???
- ???????? `OpenGL main.cpp` ? Visual Studio
- ??????? ? ???????? ????????? ??????
- ????????? ????
- ???????? `Venchile.cpp` ? ??????? ?????????
- ?????????

### 2. ????????????????
```bash
msbuild OpenGL.sln /p:Configuration=Debug /p:Platform=x64 /t:Rebuild
```

### 3. ????????? ??????
```
Port Forwarding:
External Port: 8081  (???????? ? 8080!)
Internal IP:   <??? IP>
Internal Port: 8081
Protocol:      TCP
```

### 4. ????????? Firewall
```powershell
New-NetFirewallRule -DisplayName "RaceMap 8081" `
    -Direction Inbound -LocalPort 8081 -Protocol TCP -Action Allow
```

### 5. ????????? OwnTracker
```
Server URL: http://YOUR_PUBLIC_IP:8081/telemetry  (???? 8081!)
Method: POST
Format: JSON
```

### 6. ????????? ? ??????????
```bash
.\x64\Debug\OpenGL.exe
```

### 7. ????
```bash
curl http://localhost:8081/status
```

---

## ?? ????????? ?????????

### ??? ???????:
```
========================================
   RaceMap - Starting Application
========================================

[Init] Checking origin coordinates...
[Init] Origin: (56.9496, 24.1052)

[Server] Starting Global HTTP Server on port 8081...
[Main] ? Server started on port 8081!
```

### ??? ??????????? OwnTracker:
```
?? [Connection] <IP>:<PORT> (INTERNET) ?
[Vehicle] Processing telemetry for: <device_id>
[Vehicle] ? NEW vehicle added: <device_id> Total vehicles: 1
[Render] Drawing 1 vehicle(s)
```

### ? ???? OpenGL:
- ? ?????? ?????????????? ??? ??????? ?????
- ? ??????????? ? ???????? ???????
- ? ????? ????????? ??????? (WASD, scroll)

---

## ?? ???? ?? ????????

### ???? ?????:
```powershell
netstat -ano | findstr :8081
taskkill /PID <PID> /F
```

### ?????? ?? ?????:
1. ????????? origin ?????????? (?????? ????????? ? ????? ??????)
2. ?????????? zoom out (scroll ?????)
3. ??????????? ?????? (WASD)
4. ????????? ????: ???? ?? `[Vehicle] NEW vehicle added`?

### ?????? ?? ????????:
1. ????????? Port Forwarding
2. ????????? Firewall
3. ????????? URL ? OwnTracker (???? 8081!)
4. ????: `curl http://localhost:8081/status`

---

## ?? ?????? ?? ?????????

### 1. ???????? ?????????????? ??????????? origin
```cpp
// ??? ????????? ?????? ?????? - ?????????? origin
if (venchiles.empty() && telemetry.latitude != 0.0)
{
    jsonClass.input_latitude = telemetry.latitude;
    jsonClass.input_longitude = telemetry.longitude;
    CordinateToMetersUTM(...);
    cout << "[Auto] Origin set to first vehicle position\n";
}
```

### 2. ???????? UI ?????
```cpp
// ? render loop, ??????? ????? ? ???????????:
// - ?????????? ???????? ?????
// - ?????? GPS
// - ????????
```

### 3. ???????? ??????????????? ? ???????
```cpp
// ?????? ????????????? ??????? ?? ????????
if (!venchiles.empty())
{
    auto& car = venchiles[0];
    cameraPosition.x = car.normalized_x;
    cameraPosition.y = car.normalized_y;
}
```

### 4. ??????? ????? ?? ????????
```cpp
// ? DrawVenchileShape ???????? ????????? ????:
glBegin(GL_LINE_STRIP);
for (const auto& point : vehicle.path)
{
    glVertex2f(point.x, point.y);
}
glEnd();
```

---

## ?? ????

????? ???? ????????? ?? ????????:
- ? ?????????? HTTP ?????? ?? ????? 8081
- ? ????? ?????? ? OwnTracker ? LORA
- ? ????????? ????? ? ???????? ???????
- ? ????????? ???? ??? ???????

**?????!** ??????
