# ?? ?????? ?????? ??????? ? ????????????

## ?? ?????????? ????????

### 1. ? ???????????: ???? 8080 ?????
**???????:**
```
[Global Server] ERROR: Bind failed: 10048
Port 8080 might be in use.
```

**???????:** ?????? ?????????? ?????????? ???? 8080

**???????:** ?????? ?? ??????????? = ??? ?????? ??????

**???????:** ???????? ???? ?? 8081 ??? ?????????? 8080

---

### 2. ? ???????????: ???????? ???? ????????
**???????:** ?????? ?????????? `TelemetryServer.h not found`

**???????:** ? ???? ???????????? ????????????:
- `TelemetryServer` (?? ??????????)
- `GlobalHttpServer` (??????????)

**???????:** ?????? ?? ?????????????

**???????:** ??????? ??? ?????????? `TelemetryServer`

---

### 3. ? ???????????: ?????? ?? ??????????????
**???????:** ?????? ????????, ?? ?????? ?? ?????

**???????:** ??????? ??????? ? ????:
```cpp
void VenchileManager::RenderVenchiles(bool trackLoaded)
{
    if (!trackLoaded) return;  // ? ????????? ?????????
}
```

?????? ?? ???????? ???? ???? ?? ??????!

**???????:** ?????????? ??????? ?????? ??? ????????????

**???????:** ?????? ??????? ??? ?????? ?????????? `true`

---

### 4. ?? ??????: Origin ?? ???????????????
**???????:** ?????? ?????????? ? ???????????? ??????????? ??? ?????? ?? ????????? ??????

**???????:** `jsonClass` (origin ??????????) = (0, 0)

**???????:** ??????????? GPS ? normalized ????????????

**???????:** ???????????????? origin ??? ??????

---

### 5. ?? ???????: ??? debug ?????
**???????:** ?????? ??????, ??? ?????? ????????

**???????:** ??????????? ???????????

**???????:** ?????? ???????

**???????:** ???????? ????????? ????

---

## ??? ???????????? ?? ???????????

### ?? 1. ?????? ?????? (?????? ????)

**???????:** ??????? ???????????? 2 ??????? ? ????????

**?????????????:**
```
?????????????????????????????????????????
?   GlobalHttpServer (???? 8081)       ?
?   - HTTP endpoints                    ?
?   - WebSocket (future)                ?
?   - CORS headers                      ?
?????????????????????????????????????????
             ?
             ?
?????????????????????????????????????????
?   VenchileManager                     ?
?   - Thread-safe operations            ?
?   - Vehicle lifecycle                 ?
?   - Coordinate conversion             ?
?????????????????????????????????????????
```

**????????????:**
- ? ???? ????
- ? ????? ?????????
- ? ????? ????????? (???????? WebSocket, REST API, etc)

---

### ?? 2. ?????? ?????????

**???????:** ?????? ???????? ?????? ? ??????

**?????????????:** ??? ??????:
```cpp
enum class RenderMode
{
    AlwaysRender,      // ??? ????????????
    OnlyWithTrack,     // Production
    Auto               // ???????????????
};
```

**?????????????:**
```cpp
// ? ??????????
RenderMode mode = RenderMode::Auto;

// ? render loop
if (mode == RenderMode::AlwaysRender || 
    (mode == RenderMode::OnlyWithTrack && g_trackLoaded) ||
    (mode == RenderMode::Auto && (g_trackLoaded || venchileManager.GetVenchileCount() > 0)))
{
    venchileManager.RenderVenchiles(true);
}
```

---

### ?? 3. ?????????????? Origin

**???????:** ????? ??????? ????????????? origin

**?????????????:** ??????????????? ?? ?????? ??????:
```cpp
class VenchileManager
{
private:
    bool m_originSet = false;
    JsonInput m_dynamicOrigin;

public:
    void UpdateFromTelemetry(const ParsedTelemetry& telemetry)
    {
        // ?????? ?????? = origin
        if (!m_originSet && telemetry.latitude != 0.0)
        {
            m_dynamicOrigin.input_latitude = telemetry.latitude;
            m_dynamicOrigin.input_longitude = telemetry.longitude;
            CordinateToMetersUTM(...);
            m_originSet = true;
            
            std::cout << "[Auto] Origin set to: (" 
                      << telemetry.latitude << ", " 
                      << telemetry.longitude << ")\n";
        }
        
        // ?????????? dynamic origin
        ConvertToNormalizedCoordinates(vehicle, m_dynamicOrigin);
    }
};
```

**????????????:**
- ? ?? ????? ????? ?????????? ???????
- ? ???????? ??? ??????
- ? ?????????????? ?????????

---

### ?? 4. ???????????? ????? ????

**???????:** ??????? ?????????? ? ????

**?????????????:** `config.json`:
```json
{
  "server": {
    "port": 8081,
    "bindAddress": "0.0.0.0"
  },
  "origin": {
    "latitude": 56.9496,
    "longitude": 24.1052,
    "autoDetect": true
  },
  "rendering": {
    "mode": "auto",
    "vehicleRadius": 0.01,
    "pathLength": 50
  },
  "debug": {
    "verboseLogging": true,
    "showFPS": true
  }
}
```

**????????:**
```cpp
#include <nlohmann/json.hpp>
#include <fstream>

class Config
{
public:
    static Config& Get()
    {
        static Config instance;
        return instance;
    }
    
    void Load(const std::string& filename)
    {
        std::ifstream file(filename);
        json config = json::parse(file);
        
        serverPort = config["server"]["port"];
        originLat = config["origin"]["latitude"];
        autoDetectOrigin = config["origin"]["autoDetect"];
        // ...
    }
    
    uint16_t serverPort = 8081;
    double originLat = 56.9496;
    double originLon = 24.1052;
    bool autoDetectOrigin = true;
    // ...
};

// ? main():
Config::Get().Load("config.json");
StartGlobalHttpServer(&venchileManager, Config::Get().serverPort);
```

---

### ?? 5. ??????????? ????? ???????

**???????:** `std::cout` ?????

**?????????????:** Logger class:
```cpp
enum class LogLevel { DEBUG, INFO, WARNING, ERROR };

class Logger
{
public:
    static void Log(LogLevel level, const std::string& category, const std::string& message)
    {
        auto now = std::chrono::system_clock::now();
        auto time = std::chrono::system_clock::to_time_t(now);
        
        std::cout << "[" << LevelToString(level) << "]"
                  << "[" << category << "] "
                  << message << "\n";
        
        // ????? ????? ? ????
        if (level >= LogLevel::WARNING)
        {
            std::ofstream logFile("racemap.log", std::ios::app);
            logFile << std::ctime(&time) << " " << message << "\n";
        }
    }
    
    static void Debug(const std::string& category, const std::string& message)
    {
        if (Config::Get().verboseLogging)
            Log(LogLevel::DEBUG, category, message);
    }
    
    static void Info(const std::string& category, const std::string& message)
    {
        Log(LogLevel::INFO, category, message);
    }
    
    static void Warning(const std::string& category, const std::string& message)
    {
        Log(LogLevel::WARNING, category, message);
    }
    
    static void Error(const std::string& category, const std::string& message)
    {
        Log(LogLevel::ERROR, category, message);
    }
};

// ?????????????:
Logger::Info("Server", "Starting on port 8081");
Logger::Debug("Vehicle", "Updated position: (" + std::to_string(x) + ", " + std::to_string(y) + ")");
Logger::Warning("GPS", "Fix quality low: " + std::to_string(fixType));
Logger::Error("Network", "Failed to bind socket: " + std::to_string(WSAGetLastError()));
```

---

### ?? 6. ??????????????? ??????????

**???????:** ??????? mutex locks

**?????????????:** RAII + thread-safe ???????:
```cpp
// Thread-safe queue ??? ??????????
template<typename T>
class ThreadSafeQueue
{
private:
    std::queue<T> m_queue;
    mutable std::mutex m_mutex;
    std::condition_variable m_cv;

public:
    void Push(T item)
    {
        std::lock_guard<std::mutex> lock(m_mutex);
        m_queue.push(std::move(item));
        m_cv.notify_one();
    }
    
    bool TryPop(T& item, std::chrono::milliseconds timeout)
    {
        std::unique_lock<std::mutex> lock(m_mutex);
        if (m_cv.wait_for(lock, timeout, [this]{ return !m_queue.empty(); }))
        {
            item = std::move(m_queue.front());
            m_queue.pop();
            return true;
        }
        return false;
    }
};

// ?????????????:
class VenchileManager
{
private:
    ThreadSafeQueue<ParsedTelemetry> m_telemetryQueue;
    std::thread m_processingThread;
    std::atomic<bool> m_running{false};
    
public:
    void Start()
    {
        m_running = true;
        m_processingThread = std::thread(&VenchileManager::ProcessLoop, this);
    }
    
    void QueueTelemetry(const ParsedTelemetry& telemetry)
    {
        m_telemetryQueue.Push(telemetry);  // Thread-safe
    }
    
private:
    void ProcessLoop()
    {
        while (m_running)
        {
            ParsedTelemetry telemetry;
            if (m_telemetryQueue.TryPop(telemetry, std::chrono::milliseconds(100)))
            {
                ProcessTelemetry(telemetry);  // ????????? ? ????????? ??????
            }
        }
    }
};
```

**????????????:**
- ? ?????? ?? ??????????? ?? ????? ?????????
- ? Batch ????????? ????????
- ? ?????? ?? race conditions

---

### ?? 7. ????????? ??????

**???????:** ??????????? ????????

**?????????????:** ?????? ?????????:
```cpp
class TelemetryValidator
{
public:
    struct ValidationResult
    {
        bool valid;
        std::string error;
    };
    
    static ValidationResult Validate(const ParsedTelemetry& telemetry)
    {
        // Device ID
        if (telemetry.deviceId.empty())
            return {false, "Empty device ID"};
        
        // GPS coordinates
        if (std::abs(telemetry.latitude) > 90.0)
            return {false, "Invalid latitude: " + std::to_string(telemetry.latitude)};
        
        if (std::abs(telemetry.longitude) > 180.0)
            return {false, "Invalid longitude: " + std::to_string(telemetry.longitude)};
        
        // Speed (sanity check: < 500 km/h)
        if (telemetry.speed < 0 || telemetry.speed > 140.0)  // 140 m/s = 504 km/h
            return {false, "Unrealistic speed: " + std::to_string(telemetry.speed)};
        
        // Timestamp (not in future, not too old)
        auto now = std::time(nullptr);
        auto telemetryTime = telemetry.timestamp / 1000;  // ms to sec
        if (telemetryTime > now + 60)
            return {false, "Timestamp in future"};
        if (now - telemetryTime > 3600)  // 1 hour old
            return {false, "Timestamp too old"};
        
        // Satellites (0-30 realistic range)
        if (telemetry.satellites > 30)
            return {false, "Unrealistic satellite count"};
        
        return {true, ""};
    }
};

// ? Server.cpp:
if (m_venchileManager)
{
    auto validation = TelemetryValidator::Validate(telemetry);
    if (validation.valid)
    {
        m_venchileManager->UpdateFromTelemetry(telemetry);
    }
    else
    {
        Logger::Warning("Telemetry", "Invalid data: " + validation.error);
        return false;
    }
}
```

---

### ?? 8. Error Recovery

**???????:** ??? ?????? - ?????? ????? ? ???????

**?????????????:** Graceful degradation:
```cpp
class ErrorHandler
{
public:
    static void HandleConnectionError(const std::string& clientIP)
    {
        // ????????
        Logger::Warning("Network", "Connection error from " + clientIP);
        
        // ??????????
        s_errorStats[clientIP]++;
        
        // ?????????? ??? ?????? ???????
        if (s_errorStats[clientIP] > 10)
        {
            Logger::Error("Network", "Blocking " + clientIP + " due to excessive errors");
            s_blockedIPs.insert(clientIP);
        }
    }
    
    static void HandleGPSOutlier(const Venchile& vehicle)
    {
        // ???? ?????????? ????? ?????????? - ???????? GPS glitch
        if (vehicle.speed_kmh > 200)  // ?????????? ???????? ??? ??????????
        {
            Logger::Warning("GPS", vehicle.deviceId + " speed anomaly: " + std::to_string(vehicle.speed_kmh));
            // ?????????? ?????????? ?????????? (???????????)
        }
    }
    
private:
    static std::map<std::string, int> s_errorStats;
    static std::set<std::string> s_blockedIPs;
};
```

---

## ?? ??????????????????

### ??????? ????????:

1. **?????? frame - lock ?? venchiles**
   ```cpp
   void RenderVenchiles()
   {
       std::lock_guard<std::mutex> lock(VenchileMutex);  // ?????????? ?????? ????!
       for (auto& vehicle : venchiles) { ... }
   }
   ```

2. **Debug ????? ? ?????? ?????**
   ```cpp
   std::cout << "[Render] ...";  // ????????!
   ```

### ????????????:

#### 1. Double buffering ??? ??????????
```cpp
class VenchileManager
{
private:
    std::vector<Venchile> m_venchiles;        // ????? ??????
    std::vector<Venchile> m_renderBuffer;     // ?????? renderer
    std::mutex m_venchilesMutex;

public:
    void SwapBuffers()  // ?????????? ??? ? ????
    {
        std::lock_guard<std::mutex> lock(m_venchilesMutex);
        m_renderBuffer = m_venchiles;  // ??????? ???????????
    }
    
    void RenderVenchiles()
    {
        // ??? LOCK! ?????? ?? buffer
        for (const auto& vehicle : m_renderBuffer)
        {
            DrawVenchileShape(vehicle);
        }
    }
};
```

#### 2. Batch ???????????
```cpp
class BatchLogger
{
private:
    std::vector<std::string> m_buffer;
    std::mutex m_mutex;
    
public:
    void Log(const std::string& message)
    {
        std::lock_guard<std::mutex> lock(m_mutex);
        m_buffer.push_back(message);
        
        if (m_buffer.size() >= 10)  // Flush ?????? 10 ?????????
        {
            Flush();
        }
    }
    
    void Flush()
    {
        for (const auto& msg : m_buffer)
        {
            std::cout << msg << "\n";
        }
        m_buffer.clear();
    }
};
```

---

## ?? UI/UX ?????????

### 1. HUD (Heads-Up Display)
```cpp
void RenderHUD()
{
    // ??????????? ImGui ??? FreeType ??? ??????
    
    ImGui::Begin("Telemetry", nullptr, ImGuiWindowFlags_NoTitleBar);
    
    ImGui::Text("Active Vehicles: %zu", venchileManager.GetVenchileCount());
    ImGui::Text("Track: %s", g_trackLoaded ? "LOADED" : "NOT LOADED");
    ImGui::Text("Server: %s", IsGlobalHttpServerRunning() ? "ONLINE" : "OFFLINE");
    
    ImGui::Separator();
    
    for (const auto& vehicle : venchileManager.getVenchiles())
    {
        ImGui::Text("%s: %.1f km/h", vehicle.deviceId.c_str(), vehicle.speed_kmh);
        ImGui::SameLine();
        ImGui::Text("GPS: %d sats", vehicle.satellites);
    }
    
    ImGui::End();
}
```

### 2. ????????
```cpp
void RenderMinimap()
{
    // ? ???? ?????? - ????? ????? ?????
    glViewport(windowWidth - 200, windowHeight - 200, 200, 200);
    
    // ?????? ???? ???????
    RenderTrack(/* mini scale */);
    
    // ?????? ?????? ??? ?????
    for (const auto& vehicle : vehicles)
    {
        glBegin(GL_POINTS);
        glVertex2f(vehicle.normalized_x, vehicle.normalized_y);
        glEnd();
    }
    
    // Restore viewport
    glViewport(0, 0, windowWidth, windowHeight);
}
```

### 3. ??????? ????????
```cpp
glm::vec3 GetSpeedColor(double speed_kmh)
{
    if (speed_kmh < 10) return glm::vec3(0.3, 0.3, 0.3);  // ????? (?????)
    if (speed_kmh < 30) return glm::vec3(0.0, 1.0, 0.0);  // ??????? (????????)
    if (speed_kmh < 60) return glm::vec3(1.0, 1.0, 0.0);  // ?????? (??????)
    if (speed_kmh < 100) return glm::vec3(1.0, 0.5, 0.0); // ????????? (??????)
    return glm::vec3(1.0, 0.0, 0.0);  // ??????? (????? ??????)
}
```

---

## ?? ????????????

### ????????????:

1. **API ?????** (??. SECURITY_GUIDE.md)
2. **Rate limiting** (???? 60 req/min per IP)
3. **Input sanitization** (???????? JSON)
4. **HTTPS** (nginx reverse proxy)
5. **IP whitelist** (?????? ????????? ??????????)

---

## ?? ???????? ????????????

### ??????????? ??????????? (???????):
1. ? ???????? ???? ?? 8081
2. ? ??????? TelemetryServer
3. ? ?????? ?????????? ????????? ?? trackLoaded
4. ? ???????????????? origin
5. ? ???????? debug ????

### ????????????? ????????? (??? ??????):
1. ?????????????? origin
2. ???????????????? ????
3. Logger ???????
4. ????????? ??????
5. Error recovery

### ????????????? ????????? (???? ?????):
1. Double buffering ??? ??????????????????
2. HUD ? ???????????
3. ????????
4. ???????? ????????? ????????
5. API ????? ??? ????????????

### ???????????? ????????? (???????):
1. WebSocket ??? real-time (?????? HTTP polling)
2. ???? ?????? ??? ??????? (SQLite/PostgreSQL)
3. Replay ???????
4. Multi-session ?????????
5. Web dashboard (React/Vue)

---

## ?? ????????? ??????????

????? ?????????? ???????????:
- ? **????????????:** ??? crashes, graceful errors
- ? **??????????????????:** 60 FPS ? 10+ ????????
- ? **????????:** ????? ????????? ? ????????
- ? **????????????????:** ????????? 50+ ?????????
- ? **????????????:** ?????? ?? ??????? ????

---

**?????:** Senior C++ Developer
**????:** 2024
**??????:** 1.0

**??????? ? ????? ????????!** ??
