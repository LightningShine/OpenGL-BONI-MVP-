# ?? ?????? ??????? ? ???????

## ? ??????????? ????????

### 1. **???? 8080 ?????** ??
```
[Global Server] ERROR: Bind failed: WSAEADDRINUSE
Port 8080 might be in use.
```

**???????:** ?????? ?????????? ?????????? ???? 8080

**???????:**
```powershell
# A. ????? ? ????????? ??????? ?? ????? 8080
netstat -ano | findstr :8080
# Output: TCP 0.0.0.0:8080 0.0.0.0:0 LISTENING 12345
taskkill /PID 12345 /F

# B. ??? ???????????? ?????? ???? (8081, 9000, 3000)
```

---

### 2. **????????: TelemetryServer vs GlobalHttpServer** ??

**? main.cpp ???????:**
```cpp
#include "TelemetryServer.h"  // ? ???? ?? ??????????!
TelemetryServer telemetryServer;  // ? ?? ?????????
telemetryServer.Stop();  // ? ?????? ??????????
```

**?? ?? ????? ???????????:**
```cpp
#include "Server.h"
StartGlobalHttpServer(&venchileManager, 8080);
StopGlobalHttpServer();
```

**????????:** ??? ??????? ???????? ???????????? ???? ????!

---

### 3. **?????? ?? ??????????????** ???

**??????? ? main.cpp:**
```cpp
g_trackLoaded = (pointCount > 1) && trackClosed;
venchileManager.RenderVenchiles(g_trackLoaded);  // ? ????????? ?????? ???? ???? ??????
```

**? Venchile.cpp:**
```cpp
void VenchileManager::RenderVenchiles(bool trackLoaded)
{
    if (!trackLoaded)  // ? ???? ???? ?? ???????? - ?????
    {
        return;
    }
    // ... ?????????
}
```

**????????:** ?????? ?? ?????????????? ???? ?? ?? ????????? ????????? ????!

---

### 4. **?????? ??????????, ?? ?? ?????** ??

**??????????????????:**
1. ? ??????? ?????????? ?????? ? `POST /telemetry`
2. ? ?????? ???????? ? `ProcessTelemetryJson()`
3. ? ??????? ? `ParseOwnTrackerData()`
4. ? VenchileManager ??????????? ? `UpdateFromTelemetry()`
5. ? ?????????? ?????????????? ? `ConvertToNormalizedCoordinates()`
6. ? **??** `RenderVenchiles()` ?? ???????????? (trackLoaded = false)

**?????:** ?????? ????, ?? ?????? ????????? ????????? ?? ?????!

---

## ??? ???????

### ? ??????? 1: ????????? main.cpp (?????? TelemetryServer)

**????????:** ?????? ??? ???????? ???????????? ?????????????? TelemetryServer

**???????:**
```cpp
// ? ???????:
#include "TelemetryServer.h"
TelemetryServer telemetryServer;
telemetryServer.Stop();

// ? ???????? ??????:
#include "Server.h"
StartGlobalHttpServer(&venchileManager, 8081);  // ?????????? 8081!
StopGlobalHttpServer();
```

---

### ? ??????? 2: ???????? ???? ?? 8081 (??? ????? ?????????)

**? main.cpp:**
```cpp
// ???????? ????
if (StartGlobalHttpServer(&venchileManager, 8081))  // ???? 8080
{
    cout << "\n[Main] ? Global HTTP server started on port 8081!\n";
}
```

**? ???????:**
```
External Port: 8081 ? Internal IP: 192.168.x.x:8081
```

**? OwnTracker:**
```
URL: http://YOUR_PUBLIC_IP:8081/telemetry
```

---

### ? ??????? 3: ???????????? ?????? ??? ?????

**??????? A: ?????? ???????????? (????????????? ??? ????????????)**

```cpp
// ? main.cpp, ? render loop:
// ? ????:
venchileManager.RenderVenchiles(g_trackLoaded);

// ? ???????? ??:
venchileManager.RenderVenchiles(true);  // ?????? ????????????
```

**??????? B: ???????????? ???? ???? ??????**

```cpp
// ? Venchile.cpp:
void VenchileManager::RenderVenchiles(bool trackLoaded)
{
    // ? ???????:
    // if (!trackLoaded) return;
    
    // ? ????? ??????:
    std::lock_guard<std::mutex> lock(VenchileMutex);
    
    if (venchiles.empty()) 
    {
        return;  // ??? ????? - ?????
    }
    
    // ???? ????? ???, ?????? ? ?????? ?????? ??? ?????
    if (!trackLoaded)
    {
        std::cout << "[Debug] Rendering " << venchiles.size() 
                  << " vehicles without track\n";
    }
    
    for (const auto& vehicle : venchiles)
    {
        if (HasValidFix(vehicle))
        {
            DrawVenchileShape(vehicle);
        }
    }
}
```

---

### ? ??????? 4: ???????? DEBUG ????

**? Server.cpp, ? ProcessTelemetryJson:**
```cpp
bool GlobalHttpServer::ProcessTelemetryJson(const std::string& jsonStr)
{
    std::cout << "[DEBUG] Received JSON: " << jsonStr.substr(0, 200) << "...\n";
    
    try
    {
        json data = json::parse(jsonStr);
        
        // ... ??????? ...
        
        if (m_venchileManager)
        {
            std::cout << "[DEBUG] Updating vehicle: " << telemetry.deviceId << "\n";
            std::cout << "[DEBUG] GPS: " << telemetry.latitude << ", " << telemetry.longitude << "\n";
            m_venchileManager->UpdateFromTelemetry(telemetry);
            std::cout << "[DEBUG] Vehicle count: " << m_venchileManager->GetVenchileCount() << "\n";
        }
        
        return true;
    }
    catch (const json::exception& e)
    {
        std::cerr << "[ERROR] JSON parse error: " << e.what() << "\n";
        return false;
    }
}
```

**? Venchile.cpp, ? UpdateFromTelemetry:**
```cpp
void VenchileManager::UpdateFromTelemetry(const ParsedTelemetry& telemetry)
{
    std::lock_guard<std::mutex> lock(VenchileMutex);
    
    std::cout << "[DEBUG] UpdateFromTelemetry called for: " << telemetry.deviceId << "\n";
    std::cout << "[DEBUG] Before update - vehicle count: " << venchiles.size() << "\n";

    // ... update logic ...

    ConvertToNormalizedCoordinates(vehicle, jsonClass);
    
    std::cout << "[DEBUG] Normalized coords: (" 
              << vehicle.normalized_x << ", " 
              << vehicle.normalized_y << ")\n";
    
    std::cout << "[DEBUG] After update - vehicle count: " << venchiles.size() << "\n";
}
```

**? main.cpp, ? render loop:**
```cpp
// ????? ?????? RenderVenchiles
size_t vehicleCount = venchileManager.GetVenchileCount();
if (vehicleCount > 0)
{
    std::cout << "[DEBUG] Rendering " << vehicleCount << " vehicles\n";
}
```

---

### ? ??????? 5: ????????? JsonInput (origin ??????????)

**????????:** ???? `jsonClass` ?? ???????????????, ??? ?????????? ????? ????????????

**? Input.cpp, ??????? ?????????????:**
```cpp
JsonInput jsonClass;  // ??? ??? ??????????
```

**????????? ????????:**
```cpp
// ? main.cpp, ???????? ????? ?????????????:
extern JsonInput jsonClass;

int main()
{
    // ??????????????? origin ????? ???????? ???????
    std::cout << "[DEBUG] Origin coordinates:\n";
    std::cout << "  Latitude:  " << jsonClass.input_latitude << "\n";
    std::cout << "  Longitude: " << jsonClass.input_longitude << "\n";
    std::cout << "  Easting:   " << jsonClass.easting << "\n";
    std::cout << "  Northing:  " << jsonClass.northing << "\n";
    
    // ???? ??? ???? - ?????????? ???????:
    if (jsonClass.input_latitude == 0.0 && jsonClass.input_longitude == 0.0)
    {
        std::cout << "[WARNING] Origin not set! Using default (Riga, Latvia)\n";
        jsonClass.input_latitude = 56.9496;
        jsonClass.input_longitude = 24.1052;
        CordinateToMetersUTM(jsonClass.input_latitude, jsonClass.input_longitude, 
                             jsonClass.easting, jsonClass.northing);
    }
    
    // ?????? ????????? ??????
    StartGlobalHttpServer(&venchileManager, 8081);
}
```

---

## ?? ?????? ??????????? main.cpp

?????? ?????? ???????????? ??????:

